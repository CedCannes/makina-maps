version: '2.1'

services:
  redis:
    image: redis:5-alpine
    networks:
      - openmaptiles_conn
    ports:
      - "6379"

  kartotherian:
    build:
      context: kartotherian
    volumes:
      - ./kartotherian/modules/kartotherian_gl_style_server:/opt/kartotherian/packages/kartotherian/node_modules/kartotherian_gl_style_server
      - ./kartotherian/modules/kartotherian_cache:/opt/kartotherian/packages/kartotherian/node_modules/kartotherian_cache
      - ./kartotherian/modules/kartotherian_gl:/opt/kartotherian/packages/kartotherian/node_modules/kartotherian_gl
      - ./kartotherian/config.yaml:/opt/kartotherian/packages/kartotherian/config.yaml
      - ./kartotherian/sources.yaml:/opt/kartotherian/packages/kartotherian/sources.yaml
      - ./openmaptiles/build/openmaptiles.tm2source:/data/openmaptiles.tm2source
      - ./openmaptiles/data/expire_tiles:/data/expire_tiles
      - ./styles:/styles
      - ./fonts:/fonts
    links:
      - redis
    networks:
      - openmaptiles_conn
    ports:
      - "6533:6533"
    environment:
      - OPENMAPTILES_V3_TILES_URL=${BASE_URL:-http://localhost:6533}/openmaptiles_v3/{z}/{x}/{y}.pbf
      - OPENMAPTILES_V3_TILES_URL_INTERNAL=${BASE_URL:-http://kartotherian:6533}/openmaptiles_v3_raster/{z}/{x}/{y}.pbf

networks:
  openmaptiles_conn:
    name: openmaptiles_postgres_conn
    driver: bridge
